{% extends "base.html" %}

{% block title %}Tìm việc làm - CVision{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 3rem;
        padding: 2rem 0;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .page-header h1 {
        background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2.5rem;
        font-weight: 800;
    }
    
    .filter-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .filter-section:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .job-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        display: flex;
        gap: 1.5rem;
        align-items: flex-start;
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .job-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        transform: scaleY(0);
        transform-origin: top;
        transition: transform 0.4s ease;
    }
    
    .job-card:hover::before {
        transform: scaleY(1);
    }
    
    .job-card:hover {
        box-shadow: 0 12px 40px rgba(79, 70, 229, 0.15);
        transform: translateY(-6px);
        border-color: #667eea;
    }
    
    .job-logo-container {
        flex-shrink: 0;
        width: 120px;
        height: 120px;
        min-width: 120px;
        min-height: 120px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        border-radius: 16px;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .job-card:hover .job-logo-container {
        transform: scale(1.05);
        border-color: #667eea;
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2);
    }
    
    .job-logo-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 12px;
        transition: transform 0.3s ease;
    }
    
    .job-card:hover .job-logo-container img {
        transform: scale(1.1);
    }
    
    .job-logo-container i {
        font-size: 3rem;
        color: white;
        transition: transform 0.3s ease;
    }
    
    .job-card:hover .job-logo-container i {
        transform: scale(1.1) rotate(5deg);
    }
    
    .job-content {
        flex: 1;
        min-width: 0;
    }
    
    .job-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.75rem;
        line-height: 1.3;
        transition: color 0.3s ease;
    }
    
    .job-title a {
        color: inherit;
        text-decoration: none;
        background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        transition: all 0.3s ease;
    }
    
    .job-card:hover .job-title a {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .job-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        color: #64748b;
        font-size: 0.9rem;
    }
    
    .job-meta i {
        margin-right: 0.25rem;
    }
    
    .job-description {
        color: #64748b;
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    .salary-badge {
        display: inline-block;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
        padding: 0.4rem 1rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-right: 0.5rem;
        box-shadow: 0 2px 8px rgba(5, 95, 70, 0.2);
        transition: all 0.3s ease;
    }
    
    .job-card:hover .salary-badge {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(5, 95, 70, 0.3);
    }
    
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 20px;
        border: 2px dashed #e2e8f0;
    }
    
    .empty-state i {
        font-size: 5rem;
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1.5rem;
        display: block;
    }
    
    .empty-state h3 {
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    
    /* Form Controls Enhancement */
    .form-control, .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    /* Pagination Enhancement */
    .pagination {
        margin-top: 2rem;
    }
    
    .page-link {
        border-radius: 10px;
        margin: 0 0.25rem;
        border: 2px solid #e2e8f0;
        color: var(--dark-color);
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .page-link:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
    }
    
    .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }
    
    /* Jobs Count Badge */
    #jobsCount {
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        border: 2px solid #c7d2fe;
        font-weight: 600;
        color: #4f46e5;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .job-card {
            flex-direction: column;
            text-align: center;
        }
        
        .job-logo-container {
            margin: 0 auto;
        }
        
        .page-header h1 {
            font-size: 2rem;
        }
        
        .filter-section {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h1><i class="bi bi-briefcase me-2"></i>Tìm việc làm</h1>
            <p class="text-muted">Khám phá các cơ hội việc làm phù hợp với bạn</p>
        </div>
        <div id="jobsCount" class="text-muted" style="display: none;">
            <i class="bi bi-info-circle me-1"></i>
            <span id="totalJobsCount" class="fw-bold">0</span> việc làm đang tuyển
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="row g-3">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tiêu đề, mô tả...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
                <option value="">Tất cả ngành nghề</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control" id="locationFilter" placeholder="Địa điểm...">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="employmentTypeFilter">
                <option value="">Tất cả loại hình</option>
                <option value="full-time">Full-time</option>
                <option value="part-time">Part-time</option>
                <option value="contract">Hợp đồng</option>
                <option value="internship">Thực tập</option>
            </select>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary w-100" onclick="loadJobs(1)" style="border-radius: 12px; font-weight: 600;">
                <i class="bi bi-search me-1"></i>Tìm
            </button>
        </div>
    </div>
</div>

<!-- Jobs Container -->
<div id="jobsContainer">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Pagination -->
<div id="paginationContainer" class="d-flex justify-content-center mt-4"></div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const perPage = 12;
    
    async function loadCategories() {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch('/api/categories', {
                headers: token ? {
                    'Authorization': `Bearer ${token}`
                } : {}
            });
            
            const data = await response.json();
            if (data.success) {
                const select = document.getElementById('categoryFilter');
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    async function loadJobs(page = 1) {
        currentPage = page;
        const container = document.getElementById('jobsContainer');
        const paginationContainer = document.getElementById('paginationContainer');
        
        // Show loading
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Get filters
        const search = document.getElementById('searchInput').value;
        const categoryId = document.getElementById('categoryFilter').value;
        const location = document.getElementById('locationFilter').value;
        const employmentType = document.getElementById('employmentTypeFilter').value;
        
        // Build query string
        const params = new URLSearchParams({
            page: page,
            per_page: perPage
        });
        
        if (search) params.append('search', search);
        if (categoryId) params.append('category_id', categoryId);
        if (location) params.append('location', location);
        if (employmentType) params.append('employment_type', employmentType);
        
        try {
            const response = await fetch(`/api/jobs?${params.toString()}`);
            const data = await response.json();
            
            if (data.success) {
                // Debug: log để kiểm tra company_logo
                if (data.jobs && data.jobs.length > 0) {
                    console.log('Sample job data:', data.jobs[0]);
                    console.log('Company logo:', data.jobs[0].company_logo);
                }
                displayJobs(data.jobs);
                displayPagination(data.pagination);
                // Update jobs count
                if (data.pagination) {
                    const countEl = document.getElementById('totalJobsCount');
                    const countContainer = document.getElementById('jobsCount');
                    if (countEl && countContainer) {
                        countEl.textContent = data.pagination.total;
                        countContainer.style.display = 'block';
                    }
                }
            } else {
                showError(data.message || 'Không thể tải danh sách việc làm');
            }
        } catch (error) {
            console.error('Error loading jobs:', error);
            showError('Có lỗi xảy ra khi tải danh sách việc làm: ' + error.message);
        }
    }
    
    function displayJobs(jobs) {
        const container = document.getElementById('jobsContainer');
        
        if (jobs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-briefcase"></i>
                    <h3>Không tìm thấy việc làm nào</h3>
                    <p class="text-muted">Thử thay đổi bộ lọc để tìm thêm cơ hội</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = jobs.map(job => {
            const salaryText = job.salary_min && job.salary_max 
                ? `${formatSalary(job.salary_min)} - ${formatSalary(job.salary_max)} VNĐ`
                : job.salary_min 
                    ? `Từ ${formatSalary(job.salary_min)} VNĐ`
                    : 'Thỏa thuận';
            
            const expiredBadge = job.is_expired ? '<span class="badge bg-danger ms-2">Đã hết hạn</span>' : '';
            
            // Tạo logo HTML - LUÔN hiển thị logo container (có logo hoặc placeholder)
            let logoHtml = '';
            const hasLogo = job.company_logo && 
                           job.company_logo !== 'null' && 
                           job.company_logo !== 'None' && 
                           String(job.company_logo).trim() !== '';
            
            if (hasLogo) {
                // Có logo, hiển thị logo
                logoHtml = `<div class="job-logo-container">
                    <img src="${job.company_logo}" alt="Company logo" 
                         onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'bi bi-building\\' style=\\'font-size: 2.5rem; color: white;\\'></i>'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';">
                   </div>`;
            } else {
                // Không có logo, hiển thị placeholder với icon building
                logoHtml = `<div class="job-logo-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-building" style="font-size: 2.5rem; color: white;"></i>
                   </div>`;
            }
            
            return `
                <div class="job-card" onclick="window.location.href='/jobs/${job.id}'">
                    ${logoHtml}
                    <div class="job-content">
                    <h3 class="job-title">
                        <a href="/jobs/${job.id}">${job.title}</a>
                        ${expiredBadge}
                    </h3>
                    <div class="job-meta">
                        <span><i class="bi bi-geo-alt"></i>${job.location || 'Chưa cập nhật'}</span>
                        <span><i class="bi bi-tag"></i>${job.category || 'Chưa phân loại'}</span>
                        <span><i class="bi bi-briefcase"></i>${job.employment_type || 'Full-time'}</span>
                            <span><i class="bi bi-people"></i>${job.application_count || 0} ứng viên</span>
                    </div>
                    <div class="job-description">
                            ${job.description ? (job.description.length > 150 ? job.description.substring(0, 150) + '...' : job.description) : 'Không có mô tả'}
                    </div>
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3">
                        <div>
                            <span class="salary-badge">${salaryText}</span>
                            <small class="text-muted ms-2">
                                    <i class="bi bi-calendar"></i> ${formatDate(job.created_at)}
                            </small>
                        </div>
                        ${job.deadline ? `
                            <small class="text-muted">
                                    <i class="bi bi-clock"></i> Hạn nộp: ${formatDeadline(job.deadline)}
                            </small>
                        ` : ''}
                    </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function displayPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        
        if (pagination.pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<nav><ul class="pagination">';
        
        // Previous button
        if (pagination.page > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${pagination.page - 1}); return false;">Trước</a></li>`;
        }
        
        // Page numbers
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${i}); return false;">${i}</a></li>`;
            }
        }
        
        // Next button
        if (pagination.page < pagination.pages) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${pagination.page + 1}); return false;">Sau</a></li>`;
        }
        
        html += '</ul></nav>';
        container.innerHTML = html;
    }
    
    function formatSalary(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        } catch (e) {
            return dateString;
        }
    }
    
    function formatDeadline(deadlineString) {
        if (!deadlineString) return '';
        try {
            if (deadlineString.includes('T')) {
                const [datePart] = deadlineString.split('T');
                const [year, month, day] = datePart.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } else {
                const date = new Date(deadlineString);
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }
        } catch (e) {
            return deadlineString;
        }
    }
    
    function showError(message) {
        const container = document.getElementById('jobsContainer');
        container.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>${message}
            </div>
        `;
    }
    
    // Load on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadJobs();
        
        // Enter key on search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadJobs(1);
            }
        });
    });
</script>
{% endblock %}

