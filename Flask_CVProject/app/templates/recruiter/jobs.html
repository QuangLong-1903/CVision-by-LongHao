{% extends "base.html" %}

{% block title %}Quản lý bài đăng tuyển dụng - CVision{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 3rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .page-header h1 {
        background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }
    
    .job-card {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .job-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        transform: scaleY(0);
        transform-origin: top;
        transition: transform 0.4s ease;
    }
    
    .job-card:hover::before {
        transform: scaleY(1);
    }
    
    .job-card:hover {
        box-shadow: 0 12px 40px rgba(79, 70, 229, 0.15);
        transform: translateY(-6px);
        border-color: #667eea;
    }
    
    .job-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.75rem;
        line-height: 1.3;
        transition: color 0.3s ease;
    }
    
    .job-card:hover .job-title {
        background: linear-gradient(135deg, #0f172a 0%, #4f46e5 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .job-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        color: #64748b;
        font-size: 0.9rem;
    }
    
    .job-meta i {
        margin-right: 0.25rem;
    }
    
    .badge-status {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .badge-status:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .badge-active {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #065f46;
    }
    
    .badge-inactive {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }
    
    .filter-section {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .filter-section:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .filter-section .form-control,
    .filter-section .form-select {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .filter-section .form-control:focus,
    .filter-section .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        outline: none;
    }
    
    .job-logo-container {
        flex-shrink: 0;
        width: 120px;
        height: 120px;
        min-width: 120px;
        min-height: 120px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        border-radius: 16px;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        overflow: hidden;
        position: relative;
        margin-right: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .job-card:hover .job-logo-container {
        transform: scale(1.05);
        border-color: #667eea;
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.2);
    }
    
    .job-logo-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 12px;
        display: block;
        transition: transform 0.3s ease;
    }
    
    .job-card:hover .job-logo-container img {
        transform: scale(1.1);
    }
    
    .job-logo-container i {
        font-size: 3rem !important;
        color: white !important;
        display: block !important;
        transition: transform 0.3s ease;
    }
    
    .job-card:hover .job-logo-container i {
        transform: scale(1.1) rotate(5deg);
    }
    
    .job-card-content-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
    }
    
    /* Action Buttons */
    .btn-sm {
        border-radius: 10px;
        font-weight: 600;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary {
        border: 2px solid #667eea;
        color: #667eea;
    }
    
    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .btn-outline-secondary {
        border: 2px solid #64748b;
        color: #64748b;
    }
    
    .btn-outline-secondary:hover {
        background: #64748b;
        border-color: #64748b;
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-danger {
        border: 2px solid #ef4444;
        color: #ef4444;
    }
    
    .btn-outline-danger:hover {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn-outline-info {
        border: 2px solid #06b6d4;
        color: #06b6d4;
    }
    
    .btn-outline-info:hover {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        border-color: #06b6d4;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 20px;
        border: 2px dashed #e2e8f0;
    }
    
    .empty-state i {
        font-size: 5rem;
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1.5rem;
        display: block;
    }
    
    .empty-state h3 {
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    
    /* Modal Enhancement */
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        border-bottom: 2px solid #e2e8f0;
        padding: 1.5rem 2rem;
        border-radius: 20px 20px 0 0;
    }
    
    .modal-title {
        font-weight: 700;
        color: var(--dark-color);
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .modal-footer {
        border-top: 2px solid #e2e8f0;
        padding: 1.5rem 2rem;
        border-radius: 0 0 20px 20px;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 2rem;
        }
        
        .job-card-content-wrapper {
            flex-direction: column;
        }
        
        .job-logo-container {
            margin: 0 auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-briefcase me-2"></i>Quản lý bài đăng tuyển dụng</h1>
            <p class="text-muted">Quản lý các bài đăng tuyển dụng của bạn</p>
        </div>
        <a href="/recruiter/jobs/new" class="btn btn-primary" style="border-radius: 12px; font-weight: 600; padding: 0.75rem 1.5rem;">
            <i class="bi bi-plus-circle me-2"></i>Tạo bài đăng mới
        </a>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="row g-3">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tiêu đề, mô tả...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
                <option value="">Tất cả ngành nghề</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control" id="locationFilter" placeholder="Địa điểm...">
        </div>
        <div class="col-md-2">
            <select class="form-select" id="employmentTypeFilter">
                <option value="">Tất cả loại hình</option>
                <option value="full-time">Full-time</option>
                <option value="part-time">Part-time</option>
                <option value="contract">Hợp đồng</option>
                <option value="internship">Thực tập</option>
            </select>
        </div>
        <div class="col-md-1">
            <button class="btn btn-primary w-100" onclick="loadJobs(1)" style="border-radius: 12px; font-weight: 600;">
                <i class="bi bi-search me-1"></i>Tìm
            </button>
        </div>
    </div>
</div>

<div id="jobsContainer">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Pagination -->
<div id="paginationContainer" class="d-flex justify-content-center mt-4"></div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteJobModal" tabindex="-1" aria-labelledby="deleteJobModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteJobModalLabel">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Xác nhận xóa bài đăng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa bài đăng <strong id="deleteJobTitle"></strong>?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Hành động này không thể hoàn tác. Tất cả các đơn ứng tuyển liên quan cũng sẽ bị xóa.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-1"></i>Xóa bài đăng
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    const perPage = 12;
    
    async function loadCategories() {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch('/api/categories', {
                headers: token ? {
                    'Authorization': `Bearer ${token}`
                } : {}
            });
            
            const data = await response.json();
            if (data.success) {
                const select = document.getElementById('categoryFilter');
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    async function loadJobs(page = 1) {
        currentPage = page;
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        
        const container = document.getElementById('jobsContainer');
        
        // Show loading
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Get filters
        const search = document.getElementById('searchInput').value;
        const categoryId = document.getElementById('categoryFilter').value;
        const location = document.getElementById('locationFilter').value;
        const employmentType = document.getElementById('employmentTypeFilter').value;
        
        // Build query string
        const params = new URLSearchParams({
            page: page,
            per_page: perPage
        });
        
        if (search) params.append('search', search);
        if (categoryId) params.append('category_id', categoryId);
        if (location) params.append('location', location);
        if (employmentType) params.append('employment_type', employmentType);
        
        try {
            const response = await fetch(`/api/recruiter/jobs?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                displayJobs(data.jobs);
                if (data.pagination) {
                    displayPagination(data.pagination);
                }
            } else {
                showAlert('danger', data.message || 'Không thể tải danh sách bài đăng');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'Có lỗi xảy ra khi tải danh sách bài đăng');
        }
    }
    
    function displayJobs(jobs) {
        const container = document.getElementById('jobsContainer');
        
        if (jobs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-briefcase"></i>
                    <h3>Chưa có bài đăng nào</h3>
                    <p class="text-muted">Tạo bài đăng tuyển dụng đầu tiên của bạn</p>
                    <a href="/recruiter/jobs/new" class="btn btn-primary mt-3" style="padding: 0.6rem 2.5rem; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; line-height: 1;">
                        <i class=" me-2"></i>Tạo bài đăng mới
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = jobs.map(job => {
            // Tạo logo HTML - LUÔN hiển thị logo container (có logo hoặc placeholder)
            const hasLogo = job.company_logo && 
                           job.company_logo !== 'null' && 
                           job.company_logo !== 'None' && 
                           String(job.company_logo).trim() !== '';
            
            const logoHtml = hasLogo
                ? `<div class="job-logo-container">
                    <img src="${job.company_logo}" alt="Company logo" 
                         onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'bi bi-building\\' style=\\'font-size: 2.5rem; color: white;\\'></i>'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';">
                   </div>`
                : `<div class="job-logo-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-building" style="font-size: 2.5rem; color: white;"></i>
                   </div>`;
            
            return `
            <div class="job-card">
                <div class="job-card-content-wrapper">
                    ${logoHtml}
                    <div class="flex-grow-1 d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h3 class="job-title">${job.title}</h3>
                        <div class="job-meta">
                            <span><i class="bi bi-geo-alt"></i>${job.location || 'Chưa cập nhật'}</span>
                            <span><i class="bi bi-tag"></i>${job.category || 'Chưa phân loại'}</span>
                            <span><i class="bi bi-people"></i>${job.application_count} ứng viên</span>
                            <span><i class="bi bi-calendar"></i>${new Date(job.created_at).toLocaleDateString('vi-VN')}</span>
                        </div>
                        <p class="text-muted">${job.description || ''}</p>
                    </div>
                    <div class="ms-3">
                        <span class="badge badge-status ${job.is_active ? 'badge-active' : 'badge-inactive'}">
                                <i class="bi ${job.is_active ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                            ${job.is_active ? 'Đang hoạt động' : 'Đã tắt'}
                        </span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <a href="/recruiter/jobs/${job.id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye me-1"></i>Xem chi tiết
                    </a>
                    <a href="/recruiter/jobs/${job.id}/edit" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil me-1"></i>Chỉnh sửa
                    </a>
                    <a href="/recruiter/applications?job_id=${job.id}" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-people me-1"></i>Ứng viên (${job.application_count || 0})
                    </a>
                    <button class="btn btn-sm btn-outline-danger delete-job-btn" data-job-id="${job.id}" data-job-title="${(job.title || '').replace(/"/g, '&quot;')}">
                        <i class="bi bi-trash me-1"></i>Xóa
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('jobsContainer').insertBefore(alertDiv, document.getElementById('jobsContainer').firstChild);
    }
    
    let jobToDelete = null;
    
    function confirmDeleteJob(jobId, jobTitle) {
        jobToDelete = jobId;
        document.getElementById('deleteJobTitle').textContent = jobTitle;
        const modal = new bootstrap.Modal(document.getElementById('deleteJobModal'));
        modal.show();
    }
    
    async function deleteJob() {
        if (!jobToDelete) return;
        
        const token = localStorage.getItem('access_token');
        if (!token) {
            showAlert('danger', 'Vui lòng đăng nhập lại');
            return;
        }
        
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang xóa...';
        
        try {
            const response = await fetch(`/api/recruiter/jobs/${jobToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Đóng modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteJobModal'));
                modal.hide();
                
                // Hiển thị thông báo thành công
                showAlert('success', data.message || 'Xóa bài đăng thành công');
                
                // Reload danh sách
                setTimeout(() => {
                    loadJobs();
                }, 500);
            } else {
                showAlert('danger', data.message || 'Không thể xóa bài đăng');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('danger', 'Có lỗi xảy ra khi xóa bài đăng');
        } finally {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
            jobToDelete = null;
        }
    }
    
    // Gắn sự kiện cho nút xác nhận xóa và các nút xóa
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteJob);
        
        // Sử dụng event delegation cho các nút xóa (vì chúng được tạo động)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-job-btn')) {
                const btn = e.target.closest('.delete-job-btn');
                const jobId = parseInt(btn.getAttribute('data-job-id'));
                const jobTitle = btn.getAttribute('data-job-title');
                confirmDeleteJob(jobId, jobTitle);
            }
        });
        
        loadCategories();
        loadJobs(1);
        
        // Enter key on search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadJobs(1);
            }
        });
    });
    
    function displayPagination(pagination) {
        const container = document.getElementById('paginationContainer');
        
        if (!pagination || pagination.pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<nav><ul class="pagination">';
        
        // Previous button
        if (pagination.page > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${pagination.page - 1}); return false;">Trước</a></li>`;
        }
        
        // Page numbers
        for (let i = 1; i <= pagination.pages; i++) {
            if (i === pagination.page) {
                html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${i}); return false;">${i}</a></li>`;
            }
        }
        
        // Next button
        if (pagination.page < pagination.pages) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${pagination.page + 1}); return false;">Sau</a></li>`;
        }
        
        html += '</ul></nav>';
        container.innerHTML = html;
    }
</script>
{% endblock %}

